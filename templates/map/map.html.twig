{#{% extends 'base.html.twig' %}#}

{#{% block title %}Map{% endblock %}#}

{#{% block body %}#}
    {#<div id="root"></div>#}
{#{% endblock %}#}

{#{% block javascripts %}#}
    {#<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDxFs6BvSj-oMOLNcgaNqpCFJeml4LXEX4"></script>#}
    {#<script src="{{asset("build/js/map.js")}}"></script>#}
{#{% endblock %}#}


{% extends 'base.html.twig' %}

{% block title %}Map{% endblock %}

{% block body %}
    <div id="map-container">
        <div id="map"></div>
    </div>
    <button onclick="geoFindMe()">Show my location</button>
{% endblock %}

{% block javascripts %}
    <style type="text/css">

        #map-container {
            width: 100%;
        }

        #map {
            width: 100%;
            height: 550px;
        }

        .info {
            width: 200px;
        }

        .info img {
            border: 0;
        }

        .info-body {
            width: 200px;
            height: 200px;
            line-height: 200px;
            margin: 2px 0;
            text-align: center;
            overflow: hidden;
        }

        .info-img {
            height: 220px;
            width: 200px;
        }

    </style>

    <script src="http://maps.googleapis.com/maps/api/js?v=3&amp;sensor=false"></script>
    <script type="text/javascript" src="{{asset("map/data.json")}}"></script>
    <script type="text/javascript" src="{{asset("map/markerclusterer.min.js")}}"></script>

    <script type="text/javascript">
        const mapvars = {};
        mapvars.infoWindow = null;
        mapvars.map = null;

        function initialize() {
            const center = new google.maps.LatLng(55, 24);

            mapvars.map = new google.maps.Map(document.getElementById('map'), {
                zoom: 7,
                center: center,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
            });

            mapvars.infoWindow = new google.maps.InfoWindow();
            const markers = [];
            const imageUrl = 'http://chart.apis.google.com/chart?cht=mm&chs=24x32&chco=' +
                'FFFFFF,008CFF,000000&ext=.png';
            const markerImage = new google.maps.MarkerImage(imageUrl,
                new google.maps.Size(24, 32));

            for (let i = 0; i < data.photos.length; i++) {
                let dataPhoto = data.photos[i];
                let latLng = new google.maps.LatLng(dataPhoto.latitude,
                    dataPhoto.longitude);

                let marker = new google.maps.Marker({
                    position: latLng,
                    icon: markerImage
                });
                let fn = mapvars.markerClickFunction(dataPhoto, latLng);
                google.maps.event.addListener(marker, 'click', fn);
                markers.push(marker);
            }
            const markerCluster = new MarkerClusterer(mapvars.map, markers);
        }
        mapvars.markerClickFunction = function (pic, latlng) {
            return function(e) {
                e.cancelBubble = true;
                e.returnValue = false;
                if (e.stopPropagation) {
                    e.stopPropagation();
                    e.preventDefault();
                }
                console.log(pic);
                let title = pic.photo_title;
                let url = pic.photo_url;
                let fileurl = pic.photo_file_url;

                let infoHtml = '<div class="info"><h3>' + title +
                    '</h3><div class="info-body">' +
                    '<a href="' + url + '" target="_blank"><img src="' +
                    fileurl + '" class="info-img"/></a></div>' +
                    '<a href="http://www.panoramio.com/" target="_blank">' +
                    '<img src="http://maps.google.com/intl/en_ALL/mapfiles/' +
                    'iw_panoramio.png"/></a><br/>' +
                    '<a href="' + pic.owner_url + '" target="_blank">' + pic.owner_name +
                    '</a></div></div>';

                mapvars.infoWindow.setContent(infoHtml);
                mapvars.infoWindow.setPosition(latlng);
                mapvars.infoWindow.open(mapvars.map);
            };
        };
        google.maps.event.addDomListener(window, 'load', initialize);

        function geoFindMe() {

            if (!navigator.geolocation){
                console.log('Geolocation is not supported by your browser');
                return;
            }

            function success(position) {
                const latitude  = position.coords.latitude;
                const longitude = position.coords.longitude;

                console.log('Lat: ' + latitude + ', Long:' + longitude);
            }

            function error() {
                alert("Unable to retrieve your location");
            }

            navigator.geolocation.getCurrentPosition(success, error);
        }
    </script>
{% endblock %}